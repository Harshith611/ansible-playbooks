---
- name: CIS 2.3.1 - Ensure ftp client is not installed
  hosts: all
  become: yes
  vars:
    checkpoint_dir: "/var/log/cis_checkpoints"
    checkpoint_file: "{{ checkpoint_dir }}/2.3.1_remove_ftp.log"
    backup_dir: "/var/backups/cis_ftp_removal"
    ftp_pkg: "ftp"

  tasks:

    - name: Ensure checkpoint directory exists
      file:
        path: "{{ checkpoint_dir }}"
        state: directory
        mode: '0755'

    - name: Ensure backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Check if FTP is installed
      shell: rpm -q {{ ftp_pkg }}
      register: ftp_check
      ignore_errors: yes

    - name: Backup RPM list before changes (if ftp is installed)
      shell: rpm -qa > {{ backup_dir }}/rpm_list_before_ftp_removal.txt
      when: ftp_check.rc == 0

    - name: Log FTP status before any action
      lineinfile:
        path: "{{ checkpoint_file }}"
        create: yes
        line: >
          {% if ftp_check.rc == 0 %}
          FTP client was installed: {{ ftp_check.stdout }}
          {% else %}
          FTP client was NOT installed.
          {% endif %}

    - name: Remove FTP client if present
      dnf:
        name: "{{ ftp_pkg }}"
        state: absent
      when: ftp_check.rc == 0

    - name: Verify FTP removal
      shell: rpm -q {{ ftp_pkg }}
      register: ftp_post_check
      ignore_errors: yes

    - name: Log removal result
      lineinfile:
        path: "{{ checkpoint_file }}"
        line: >
          {% if ftp_post_check.rc != 0 %}
          FTP removal confirmed or not present.
          {% else %}
          FTP removal failed: {{ ftp_post_check.stdout }}
          {% endif %}

    - name: Fail if FTP still installed
      fail:
        msg: "FTP package is still installed!"
      when: ftp_post_check.rc == 0

    - name: Output checkpoint log path
      debug:
        msg: "Checkpoint log saved at {{ checkpoint_file }}"
